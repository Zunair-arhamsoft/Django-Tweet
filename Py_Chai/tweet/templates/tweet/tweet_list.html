{% extends "base.html" %}
{% block title %}All Tweets{% endblock %}
{% block content %}
<div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 m-0">Tweets</h1>
        <a
        href="{% url 'tweet:tweet_create' %}"
        class="btn btn-sm btn-outline-primary"
        >
        + Create Tweet
        </a>
    </div>
  <div id="tweet-container" class="row g-4">
    {% for item in tweet_data %}
      {% include 'tweet/_tweet_card.html' with item=item %}
    {% endfor %}
  </div>

  <div id="loading" class="text-center mt-4" style="display: none;">
    <div class="spinner-border text-primary" role="status"></div>
  </div>
</div>

<script>
    // for the infinite scroll
    let currentPage = 1;
    let isLoading = false;
    let hasMoreTweets = true; 

    function handleScroll() {
        if (isLoading || !hasMoreTweets) return;

        const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 100;
        if (nearBottom) {
            loadMoreTweets();
        }
    }

    window.addEventListener('scroll', handleScroll);

    function loadMoreTweets() {
        isLoading = true;
        currentPage += 1;
        document.getElementById('loading').style.display = 'block';

        fetch(`?page=${currentPage}`, {
            headers: {
            'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('tweet-container');
            if (data.tweets.length === 0) {
                hasMoreTweets = false;
                document.getElementById('loading').style.display = 'none';
                isLoading = false;
                return;
            }

            data.tweets.forEach(tweet => {
            const tweetCard = renderTweetCard(tweet);
            container.insertAdjacentHTML('beforeend', tweetCard);
            });

            attachLikeListeners();

            if (!data.has_next) {
                hasMoreTweets = false;
            }

            document.getElementById('loading').style.display = 'none';
            isLoading = false;
        })
        .catch(err => {
            console.error('Failed to load more tweets', err);
            document.getElementById('loading').style.display = 'none';
            isLoading = false;
        });
    }

    function renderTweetCard(tweet) {
    return `
    <div class="col-md-6 col-lg-4 d-flex tweet-card">
        <div class="card shadow-sm border-0 flex-fill d-flex flex-column">
        <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 fw-bold text-primary">@${tweet.user}</h6>
            <small class="text-muted">${tweet.created_at}</small>
            </div>

            <p class="mb-2 text-truncate-3">${tweet.text}</p>

            ${tweet.photo_url ? `
            <div class="mb-2">
            <img src="${tweet.photo_url}" class="img-fluid rounded" style="max-height: 180px; object-fit: cover; width: 100%;" />
            </div>` : ''}

            <div class="mt-auto">
            <div class="like-section" data-tweet-id="${tweet.id}">
                <button type="button" class="btn btn-sm w-100 mb-2 like-btn ${tweet.liked ? 'btn-danger' : 'btn-outline-danger'}">
                ❤️ <span class="like-count">${tweet.like_count}</span>
                </button>
            </div>

            <div class="d-flex gap-2">
                ${tweet.is_owner ? `
                <a href="/tweet/${tweet.id}/edit/" class="btn btn-sm btn-outline-primary w-50">Edit</a>
                <a href="/tweet/${tweet.id}/delete/" class="btn btn-sm btn-outline-danger w-50">Delete</a>
                ` : `
                <button class="btn btn-sm w-50 invisible">Edit</button>
                <button class="btn btn-sm w-50 invisible">Delete</button>
                `}
            </div>
            </div>
        </div>
        </div>
    </div>`;
    }

    // Function to attach like button event listeners
    function attachLikeListeners() {
        document.querySelectorAll(".like-btn").forEach(button => {
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
        });

        // Attach new listeners to all like buttons
        document.querySelectorAll(".like-btn").forEach(button => {
            button.addEventListener("click", function () {
                const parent = button.closest(".like-section");
                const tweetId = parent.dataset.tweetId;
                const likeCountSpan = parent.querySelector(".like-count");

                fetch(`/tweet/${tweetId}/like/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(response => {
                    if (response.status === 403 || response.redirected) {
                        window.location.href = "/accounts/login/?next=" + window.location.pathname;
                        return null;
                    }

                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        return response.json();
                    } else {
                        throw new Error("Expected JSON, got something else");
                    }
                })
                .then(data => {
                    if (!data) return;

                    likeCountSpan.textContent = data.like_count;
                    button.classList.toggle("btn-danger", data.liked);
                    button.classList.toggle("btn-outline-danger", !data.liked);
                })
                .catch(error => console.error("Error:", error));
            });
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener("DOMContentLoaded", function () {
        attachLikeListeners();
    });
</script>

{% endblock %}